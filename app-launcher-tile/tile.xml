<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
		xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
	<properties>
		<docker-maven-plugin.version>0.37.0</docker-maven-plugin.version>

		<it.archimedesfw.docker.network>archimedes</it.archimedesfw.docker.network>
		<it.archimedesfw.app.docker.image>local/${project.parent.artifactId}:${docker.tag}</it.archimedesfw.app.docker.image>
		<it.archimedesfw.app.docker.internal_port>8080</it.archimedesfw.app.docker.internal_port>
		<it.archimedesfw.app.docker.alias>archimedes-it-app</it.archimedesfw.app.docker.alias>
		<it.archimedesfw.app.removeVolumesOnStop>true</it.archimedesfw.app.removeVolumesOnStop>
		<it.archimedesfw.app.stopMode>graceful</it.archimedesfw.app.stopMode>
	</properties>

	<build>
		<testResources>
			<testResource>
				<directory>src/test/resources</directory>
			</testResource>
			<testResource>
				<directory>src/test/resources/app-launcher-tile/</directory>
				<filtering>true</filtering>
			</testResource>
		</testResources>
		<plugins>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-resources-plugin</artifactId>
				<configuration>
					<delimiters>
						<delimiter>@</delimiter>
					</delimiters>
					<useDefaultDelimiters>false</useDefaultDelimiters>
				</configuration>
			</plugin>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-failsafe-plugin</artifactId>
				<configuration>
					<systemPropertyVariables combine.children="append">
						<it.archimedesfw.app.endpoint>http://${it.archimedesfw.app.host}:${it.archimedesfw.app.port}</it.archimedesfw.app.endpoint>
						<it.archimedesfw.app.host>${it.archimedesfw.app.host}</it.archimedesfw.app.host>
						<it.archimedesfw.app.port>${it.archimedesfw.app.port}</it.archimedesfw.app.port>
					</systemPropertyVariables>
				</configuration>
			</plugin>
			<plugin>
				<groupId>io.fabric8</groupId>
				<artifactId>docker-maven-plugin</artifactId>
				<version>${docker-maven-plugin.version}</version>
				<executions>
					<execution>
						<id>prepare-it-app</id>
						<phase>pre-integration-test</phase>
						<goals>
							<goal>start</goal>
						</goals>
						<configuration>
							<skip>${skipTests}</skip>
							<autoCreateCustomNetworks>true</autoCreateCustomNetworks>
							<images>
								<image>
									<name>${it.archimedesfw.app.docker.image}</name>
									<alias>${it.archimedesfw.app.docker.alias}</alias>
									<run>
										<ports>
											<port>+it.archimedesfw.app.host:it.archimedesfw.app.port:${it.archimedesfw.app.docker.internal_port}</port>
										</ports>
										<wait>
											<http>
												<url>
													http://${it.archimedesfw.app.host}:${it.archimedesfw.app.port}/management/health
												</url>
												<method>GET</method>
												<status>200</status>
											</http>
											<time>50000</time>
										</wait>
										<log>
											<file>${project.build.directory}/logs/archimedes-it-app.log</file>
										</log>
										<envPropertyFile>${project.build.directory}/test-classes/.env</envPropertyFile>
										<network>
											<name>${it.archimedesfw.docker.network}</name>
											<alias>${it.archimedesfw.app.docker.alias}</alias>
										</network>
										<stopMode>${it.archimedesfw.app.docker.stopMode}</stopMode>
									</run>
								</image>
							</images>
						</configuration>
					</execution>
					<execution>
						<id>stop-remove-containers</id>
						<phase>post-integration-test</phase>
						<configuration>
							<removeVolumes>${it.archimedesfw.app.removeVolumesOnStop}</removeVolumes>
						</configuration>
						<goals>
							<goal>stop</goal>
						</goals>
					</execution>
				</executions>
			</plugin>
		</plugins>
	</build>

</project>